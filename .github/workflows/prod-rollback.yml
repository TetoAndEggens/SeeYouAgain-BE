name: Prod-Rollback

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Î°§Î∞±Ìï† Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏ (Ïòà: 20250101-123-abc1234)'
        required: true
        type: string
      issue_number:
        description: 'Í¥ÄÎ†® Ïù¥Ïäà Î≤àÌò∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)'
        required: false
      rollback_reason:
        description: 'Î°§Î∞± ÏÇ¨Ïú†'
        required: false

jobs:
  rollback:
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Image Tag
        run: |
          if [[ -z "${{ github.event.inputs.image_tag }}" ]]; then
            echo "::error::Î°§Î∞±Ìï† Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Î•º ÏûÖÎ†•Ìï¥Ïïº Ìï©ÎãàÎã§."
            exit 1
          fi
          echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Verify Image Exists
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROD_IMAGE }}:${{ env.IMAGE_TAG }}"
          if ! docker manifest inspect ${IMAGE} > /dev/null 2>&1; then
            echo "::error::Ïù¥ÎØ∏ÏßÄ ${IMAGE}Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            exit 1
          fi
          echo "Ïù¥ÎØ∏ÏßÄ ÌôïÏù∏ ÏôÑÎ£å: ${IMAGE}"

      - name: Setup SSH Keys and Config
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.PROD_BASTION_SSH_KEY }}" > ~/.ssh/bastion_key
          chmod 600 ~/.ssh/bastion_key
          
          echo "${{ secrets.PROD_PRIVATE_EC2_SSH_KEY }}" > ~/.ssh/private_key
          chmod 600 ~/.ssh/private_key
          
          cat > ~/.ssh/config <<EOF
          Host bastion
              HostName ${{ secrets.PROD_BASTION_HOST }}
              User ${{ secrets.PROD_BASTION_USERNAME }}
              IdentityFile ~/.ssh/bastion_key
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          
          Host private-ec2-1
              HostName ${{ secrets.PROD_EC2_PRIVATE_HOST_1 }}
              User ${{ secrets.PROD_EC2_PRIVATE_USERNAME }}
              IdentityFile ~/.ssh/private_key
              ProxyJump bastion
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          
          Host private-ec2-2
              HostName ${{ secrets.PROD_EC2_PRIVATE_HOST_2 }}
              User ${{ secrets.PROD_EC2_PRIVATE_USERNAME }}
              IdentityFile ~/.ssh/private_key
              ProxyJump bastion
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF
          
          chmod 600 ~/.ssh/config

      - name: Rollback EC2 Instances (Parallel)
        run: |
          (
            ssh private-ec2-1 "
              echo 'DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}' > ~/app/deploy.env && \
              echo 'DOCKER_IMAGE=${{ secrets.DOCKER_PROD_IMAGE }}' >> ~/app/deploy.env && \
              echo 'DOCKER_IMAGE_TAG=${{ env.IMAGE_TAG }}' >> ~/app/deploy.env && \
              echo 'ALB_LISTENER_ARN=${{ secrets.PROD_ALB_LISTENER_ARN }}' >> ~/app/deploy.env && \
              echo 'BLUE_TARGET_GROUP_ARN=${{ secrets.PROD_BLUE_TARGET_GROUP_ARN }}' >> ~/app/deploy.env && \
              echo 'GREEN_TARGET_GROUP_ARN=${{ secrets.PROD_GREEN_TARGET_GROUP_ARN }}' >> ~/app/deploy.env && \
              cd ~/app && chmod +x deploy.sh && ./deploy.sh
            "
            echo $? > /tmp/ec2-1-status.txt
          ) &
          PID1=$!

          (
            ssh private-ec2-2 "
              echo 'DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}' > ~/app/deploy.env && \
              echo 'DOCKER_IMAGE=${{ secrets.DOCKER_PROD_IMAGE }}' >> ~/app/deploy.env && \
              echo 'DOCKER_IMAGE_TAG=${{ env.IMAGE_TAG }}' >> ~/app/deploy.env && \
              echo 'ALB_LISTENER_ARN=${{ secrets.PROD_ALB_LISTENER_ARN }}' >> ~/app/deploy.env && \
              echo 'BLUE_TARGET_GROUP_ARN=${{ secrets.PROD_BLUE_TARGET_GROUP_ARN }}' >> ~/app/deploy.env && \
              echo 'GREEN_TARGET_GROUP_ARN=${{ secrets.PROD_GREEN_TARGET_GROUP_ARN }}' >> ~/app/deploy.env && \
              cd ~/app && chmod +x deploy.sh && ./deploy.sh
            "
            echo $? > /tmp/ec2-2-status.txt
          ) &
          PID2=$!

          wait $PID1
          wait $PID2

          EC2_1_STATUS=$(cat /tmp/ec2-1-status.txt)
          EC2_2_STATUS=$(cat /tmp/ec2-2-status.txt)

          echo "EC2-1 Î°§Î∞± ÏÉÅÌÉú: $EC2_1_STATUS"
          echo "EC2-2 Î°§Î∞± ÏÉÅÌÉú: $EC2_2_STATUS"

          if [[ "$EC2_1_STATUS" -ne 0 ]] || [[ "$EC2_2_STATUS" -ne 0 ]]; then
            echo "::error::Î°§Î∞± Ïã§Ìå® - EC2-1: $EC2_1_STATUS, EC2-2: $EC2_2_STATUS"
            exit 1
          fi

          echo "Î™®Îì† EC2 Ïù∏Ïä§ÌÑ¥Ïä§ Î°§Î∞± ÏÑ±Í≥µ"

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS_EMOJI="${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}"
          STATUS_TEXT="${{ job.status == 'success' && 'ÏÑ±Í≥µ' || 'Ïã§Ìå®' }}"
          STATUS_COLOR="${{ job.status == 'success' && '3066993' || '15158332' }}"
          
          ISSUE_LINK=""
          if [[ -n "${{ github.event.inputs.issue_number }}" ]]; then
            ISSUE_LINK="https://github.com/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}"
          fi
          
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "${STATUS_EMOJI} Prod Î°§Î∞± ${STATUS_TEXT}",
              "color": ${STATUS_COLOR},
              "fields": [
                {
                  "name": "üîô Î°§Î∞± Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏",
                  "value": "\`${{ env.IMAGE_TAG }}\`",
                  "inline": true
                },
                {
                  "name": "üë§ Î°§Î∞± Ïã§ÌñâÏûê",
                  "value": "${{ github.actor }}",
                  "inline": true
                },
                {
                  "name": "üìù Î°§Î∞± ÏÇ¨Ïú†",
                  "value": "${{ github.event.inputs.rollback_reason || 'ÏóÜÏùå' }}",
                  "inline": false
                }
                $(if [[ -n "${ISSUE_LINK}" ]]; then echo ",{\"name\": \"üîó Í¥ÄÎ†® Ïù¥Ïäà\",\"value\": \"[#${{ github.event.inputs.issue_number }}](${ISSUE_LINK})\",\"inline\": false}"; fi)
                ,{
                  "name": "üîó ÏõåÌÅ¨ÌîåÎ°úÏö∞",
                  "value": "[Ïã§Ìñâ Î°úÍ∑∏ Î≥¥Í∏∞](${WORKFLOW_URL})",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            }]
          }
          EOF
          )
          
          curl -H "Content-Type: application/json" -d "${MESSAGE}" ${DISCORD_WEBHOOK}

      - name: Rollback Summary
        if: always()
        run: |
          echo "### Î°§Î∞± ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          echo "**ÏÉÅÌÉú**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Î°§Î∞± Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Î°§Î∞± ÏÇ¨Ïú†**: ${{ github.event.inputs.rollback_reason }}" >> $GITHUB_STEP_SUMMARY