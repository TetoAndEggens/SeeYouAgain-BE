name: Dev-Rollback

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ë¡¤ë°±í•  ì´ë¯¸ì§€ íƒœê·¸ (ì˜ˆ: 20250101-123-abc1234)'
        required: true
        type: string
      issue_number:
        description: 'ê´€ë ¨ ì´ìŠˆ ë²ˆí˜¸ (ì„ íƒì‚¬í•­)'
        required: false
      rollback_reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: false

jobs:
  rollback:
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Image Tag
        run: |
          if [[ -z "${{ github.event.inputs.image_tag }}" ]]; then
            echo "::error::ë¡¤ë°±í•  ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."
            exit 1
          fi
          echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Verify Image Exists
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_DEV_IMAGE }}:${{ env.IMAGE_TAG }}"
          if ! docker manifest inspect ${IMAGE} > /dev/null 2>&1; then
            echo "::error::ì´ë¯¸ì§€ ${IMAGE}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ: ${IMAGE}"

      - name: Rollback EC2 Instances (Parallel)
        run: |
          (
            ${{ secrets.DEV_API_1_SSH_COMMAND }} << 'ENDSSH'
          cat > ~/app/deploy.env <<'ENV_EOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_IMAGE=${{ secrets.DOCKER_DEV_IMAGE }}
          DOCKER_IMAGE_TAG=${{ env.IMAGE_TAG }}
          ALB_LISTENER_ARN=${{ secrets.DEV_ALB_LISTENER_ARN }}
          BLUE_TARGET_GROUP_ARN=${{ secrets.DEV_BLUE_TARGET_GROUP_ARN }}
          GREEN_TARGET_GROUP_ARN=${{ secrets.DEV_GREEN_TARGET_GROUP_ARN }}
          ENV_EOF
          cd ~/app && chmod +x deploy.sh && ./deploy.sh
          ENDSSH
            echo $? > /tmp/ec2-1-status.txt
          ) &
          PID1=$!
          
          (
            ${{ secrets.DEV_API_2_SSH_COMMAND }} << 'ENDSSH'
          cat > ~/app/deploy.env <<'ENV_EOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_IMAGE=${{ secrets.DOCKER_DEV_IMAGE }}
          DOCKER_IMAGE_TAG=${{ env.IMAGE_TAG }}
          ALB_LISTENER_ARN=${{ secrets.DEV_ALB_LISTENER_ARN }}
          BLUE_TARGET_GROUP_ARN=${{ secrets.DEV_BLUE_TARGET_GROUP_ARN }}
          GREEN_TARGET_GROUP_ARN=${{ secrets.DEV_GREEN_TARGET_GROUP_ARN }}
          ENV_EOF
          cd ~/app && chmod +x deploy.sh && ./deploy.sh
          ENDSSH
            echo $? > /tmp/ec2-2-status.txt
          ) &
          PID2=$!
          
          wait $PID1
          wait $PID2
          
          EC2_1_STATUS=$(cat /tmp/ec2-1-status.txt)
          EC2_2_STATUS=$(cat /tmp/ec2-2-status.txt)
          
          echo "EC2-1 ë¡¤ë°± ìƒíƒœ: $EC2_1_STATUS"
          echo "EC2-2 ë¡¤ë°± ìƒíƒœ: $EC2_2_STATUS"
          
          if [[ "$EC2_1_STATUS" -ne 0 ]] || [[ "$EC2_2_STATUS" -ne 0 ]]; then
            echo "::error::ë¡¤ë°± ì‹¤íŒ¨ - EC2-1: $EC2_1_STATUS, EC2-2: $EC2_2_STATUS"
            exit 1
          fi
          
          echo "ëª¨ë“  EC2 ì¸ìŠ¤í„´ìŠ¤ ë¡¤ë°± ì„±ê³µ"

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS_EMOJI="${{ job.status == 'success' && 'âœ…' || 'âŒ' }}"
          STATUS_TEXT="${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          STATUS_COLOR="${{ job.status == 'success' && '3066993' || '15158332' }}"
          
          ISSUE_LINK=""
          if [[ -n "${{ github.event.inputs.issue_number }}" ]]; then
            ISSUE_LINK="https://github.com/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}"
          fi
          
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "${STATUS_EMOJI} Dev ë¡¤ë°± ${STATUS_TEXT}",
              "color": ${STATUS_COLOR},
              "fields": [
                {
                  "name": "ğŸ”™ ë¡¤ë°± ì´ë¯¸ì§€ íƒœê·¸",
                  "value": "\`${{ env.IMAGE_TAG }}\`",
                  "inline": true
                },
                {
                  "name": "ğŸ‘¤ ë¡¤ë°± ì‹¤í–‰ì",
                  "value": "${{ github.actor }}",
                  "inline": true
                },
                {
                  "name": "ğŸ“ ë¡¤ë°± ì‚¬ìœ ",
                  "value": "${{ github.event.inputs.rollback_reason || 'ì—†ìŒ' }}",
                  "inline": false
                }
                $(if [[ -n "${ISSUE_LINK}" ]]; then echo ",{\"name\": \"ğŸ”— ê´€ë ¨ ì´ìŠˆ\",\"value\": \"[#${{ github.event.inputs.issue_number }}](${ISSUE_LINK})\",\"inline\": false}"; fi)
                ,{
                  "name": "ğŸ”— ì›Œí¬í”Œë¡œìš°",
                  "value": "[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${WORKFLOW_URL})",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            }]
          }
          EOF
          )
          
          curl -H "Content-Type: application/json" -d "${MESSAGE}" ${DISCORD_WEBHOOK}

      - name: Rollback Summary
        if: always()
        run: |
          echo "### ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "**ìƒíƒœ**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë¡¤ë°± ì´ë¯¸ì§€ íƒœê·¸**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ë¡¤ë°± ì‚¬ìœ **: ${{ github.event.inputs.rollback_reason }}" >> $GITHUB_STEP_SUMMARY