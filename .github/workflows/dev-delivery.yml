name: Dev-Delivery

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: '배포할 버전 태그 (비워두면 최신 버전 사용)'
        required: false
      deploy_message:
        description: '배포 메시지'
        required: false

jobs:
  deliver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Version Tag
        run: |
          if [[ -z "${{ github.event.inputs.version_tag }}" ]]; then
            VERSION_TAG="${{ secrets.DEV_LATEST_TAG }}"
            if [[ -z "$VERSION_TAG" ]]; then
              echo "::error::최신 버전 태그를 찾을 수 없습니다."
              exit 1
            fi
            echo "최신 버전 사용: $VERSION_TAG"
          else
            VERSION_TAG="${{ github.event.inputs.version_tag }}"
            echo "지정된 버전 사용: $VERSION_TAG"
          fi
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV

      - name: Download JAR Artifact
        uses: actions/download-artifact@v3
        with:
          name: app-jar-${{ env.VERSION_TAG }}
          path: ./artifacts

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        run: |
          BASE_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_DEV_IMAGE }}"
          docker buildx build --platform linux/amd64 \
            -f Dockerfile-dev \
            -t ${BASE_IMAGE}:latest \
            -t ${BASE_IMAGE}:${{ env.VERSION_TAG }} \
            --push .

      - name: Delivery Summary
        run: |
          echo "### Docker 이미지 배포 완료" >> $GITHUB_STEP_SUMMARY
          echo "**버전 태그**: \`${{ env.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**이미지 URL**: \`${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_DEV_IMAGE }}:${{ env.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY