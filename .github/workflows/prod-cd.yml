name: Prod-CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    if: |
      github.ref == 'refs/heads/main' && 
      (github.event_name == 'push' || github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SUBMODULE_TOKEN }}
          submodules: true

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Generate Version Tag
        id: generate_tag
        run: |
          BUILD_DATE=$(date +'%Y%m%d')
          SHORT_SHA=${GITHUB_SHA::7}
          VERSION="${BUILD_DATE}-${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated version: $VERSION"

      - name: Build JAR Artifact
        run: |
          mkdir -p ./artifacts
          echo "Generated JAR files:"
          ls -la build/libs/
          cp $(ls build/libs/*.jar | grep -v plain) ./artifacts/app.jar

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        run: |
          BASE_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROD_IMAGE }}"
          docker buildx build --platform linux/amd64 \
            -f Dockerfile \
            -t ${BASE_IMAGE}:latest \
            -t ${BASE_IMAGE}:${{ env.VERSION }} \
            --push .

      - name: Deploy to EC2 Instances (Parallel)
        run: |
          (
            ${{ secrets.PROD_API_1_SSH_COMMAND }} << 'ENDSSH'
          cat > ~/app/deploy.env <<'ENV_EOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE=${{ secrets.DOCKER_PROD_IMAGE }}
          DOCKER_IMAGE_TAG=${{ env.VERSION }}
          ALB_LISTENER_ARN=${{ secrets.PROD_ALB_LISTENER_ARN }}
          BLUE_TARGET_GROUP_ARN=${{ secrets.PROD_BLUE_TARGET_GROUP_ARN }}
          GREEN_TARGET_GROUP_ARN=${{ secrets.PROD_GREEN_TARGET_GROUP_ARN }}
          ENV_EOF
          cd ~/app && chmod +x deploy.sh && ./deploy.sh
          ENDSSH
            echo $? > /tmp/ec2-1-status.txt
          ) &
          PID1=$!

          (
            ${{ secrets.PROD_API_2_SSH_COMMAND }} << 'ENDSSH'
          cat > ~/app/deploy.env <<'ENV_EOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE=${{ secrets.DOCKER_PROD_IMAGE }}
          DOCKER_IMAGE_TAG=${{ env.VERSION }}
          ALB_LISTENER_ARN=${{ secrets.PROD_ALB_LISTENER_ARN }}
          BLUE_TARGET_GROUP_ARN=${{ secrets.PROD_BLUE_TARGET_GROUP_ARN }}
          GREEN_TARGET_GROUP_ARN=${{ secrets.PROD_GREEN_TARGET_GROUP_ARN }}
          ENV_EOF
          cd ~/app && chmod +x deploy.sh && ./deploy.sh
          ENDSSH
            echo $? > /tmp/ec2-2-status.txt
          ) &
          PID2=$!

          wait $PID1
          wait $PID2

          EC2_1_STATUS=$(cat /tmp/ec2-1-status.txt)
          EC2_2_STATUS=$(cat /tmp/ec2-2-status.txt)

          echo "EC2-1 Î∞∞Ìè¨ ÏÉÅÌÉú: $EC2_1_STATUS"
          echo "EC2-2 Î∞∞Ìè¨ ÏÉÅÌÉú: $EC2_2_STATUS"

          if [[ "$EC2_1_STATUS" -ne 0 ]] || [[ "$EC2_2_STATUS" -ne 0 ]]; then
            echo "::error::Î∞∞Ìè¨ Ïã§Ìå® - EC2-1: $EC2_1_STATUS, EC2-2: $EC2_2_STATUS"
            exit 1
          fi

          echo "Î™®Îì† EC2 Ïù∏Ïä§ÌÑ¥Ïä§ Î∞∞Ìè¨ ÏÑ±Í≥µ"

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS_EMOJI="${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}"
          STATUS_TEXT="${{ job.status == 'success' && 'ÏÑ±Í≥µ' || 'Ïã§Ìå®' }}"
          STATUS_COLOR="${{ job.status == 'success' && '3066993' || '15158332' }}"
          
          ISSUE_LINK=""
          if [[ -n "${{ github.event.inputs.issue_number }}" ]]; then
            ISSUE_LINK="https://github.com/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}"
          fi
          
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "${STATUS_EMOJI} Prod Î∞∞Ìè¨ ${STATUS_TEXT}",
              "color": ${STATUS_COLOR},
              "fields": [
                {
                  "name": "üè∑Ô∏è Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏",
                  "value": "\`${{ env.VERSION }}\`",
                  "inline": true
                },
                {
                  "name": "üë§ Î∞∞Ìè¨Ïûê",
                  "value": "${{ github.actor }}",
                  "inline": true
                },
                {
                  "name": "üìù Î∞∞Ìè¨ Î©îÏãúÏßÄ",
                  "value": "CI ÏÑ±Í≥µ ÌõÑ ÏûêÎèô Î∞∞Ìè¨",
                  "inline": false
                },
                {
                  "name": "üîó ÏõåÌÅ¨ÌîåÎ°úÏö∞",
                  "value": "[Ïã§Ìñâ Î°úÍ∑∏ Î≥¥Í∏∞](${WORKFLOW_URL})",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            }]
          }
          EOF
          )
          
          curl -H "Content-Type: application/json" -d "${MESSAGE}" ${DISCORD_WEBHOOK}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Î∞∞Ìè¨ ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          echo "**ÏÉÅÌÉú**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏**: \`${{ env.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Î∞∞Ìè¨ Î©îÏãúÏßÄ**: CI ÏÑ±Í≥µ ÌõÑ ÏûêÎèô Î∞∞Ìè¨" >> $GITHUB_STEP_SUMMARY